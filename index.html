<!DOCTYPE html>
<meta charset="utf-8">
<head>
	<title>Religions index map 2013</title>
	<style>

	body {
	  background: #fff;
	}
	
	svg {
		background: #eee;
	}

	.stroke {
	  fill: none;
	  stroke: #020;
	  stroke-width: 3px;
	}

	.fill {
	  fill: #fff;
	}

	.graticule {
	  fill: none;
	  stroke: #000;
	  stroke-width: .2px;
	}

	.boundary {
	  fill: none;
	  stroke: #fff;
	  stroke-width: .6px;
	}

	</style>
	<script src="d3.js"></script>
	<script src="queue.v1.min.js"></script>
</head>	

<body>

<script>


//définition du canvas
var width = 800,
    height = 600;

// définition du type de projection
var projection = d3.geo.mercator()
  .scale(80)
  .translate([width / 2, height / 2]);

// application du type de projection à la forme Path
var path = d3.geo.path()
  .projection(projection);

var graticule = d3.geo.graticule();

// création de l'objet svg
var svg = d3.select("body").append("svg")
  .attr("width", width)
  .attr("height", height);

//création de la shpère de fond
svg.append("defs").append("path")
	.datum({type: "Sphere"})
  .attr("id", "sphere")
  .attr("d", path)
	.style("fill", "hsl(180, 50%, 50%)");

svg.append("use")
  .attr("class", "stroke")
  .attr("xlink:href", "#sphere");

svg.append("use")
  .attr("class", "fill")
  .attr("xlink:href", "#sphere");

// ajout des graticules à l'objet svg
svg.append("path")
  .datum(graticule)
  .attr("class", "graticule")
  .attr("d", path);


var religionDominante = [];


queue().defer(d3.csv, "WRPstate2010.csv", function(d, i){ traiterReligions(d, i); })
	.defer(d3.csv, "COWstate.csv", function(d){ traiterNoms(d); })
	.await(ready);






function traiterReligions(d, i) {
		
	var selection = [
		[ d.chrstgenpct, "Christianity", "hsl(0, 50%, 50%)" ], 
		[ d.judgenpct, "Juif", "hsl(40, 50%, 50%)" ],
		[ d.islmgenpct, "Islam", "hsl(80, 50%, 50%)" ],
		[ d.budgenpct, "Bouddhism", "hsl(120, 50%, 50%)" ],
		[ d.hindgenpct, "Hindou", "hsl(160, 50%, 50%)" ]
		];

	var max = 0;
	var index = 0;
	selection.forEach(function(selec, j){
		if(selec[0] > max){ max = selec[0]; index = j; }
	});
	religionDominante[i] = [d.state, selection[index][1], selection[index][2] ];

} 




function traiterNoms(d) {

	religionDominante.forEach(function(r, i){
		if(r[0] == d.id){ religionDominante[i][0] = d.name; }		
	});	

} 




function ready()
{

	d3.json("world-countries.json", function(collection) {

		var groupFeatures = svg.append("svg:g"); 	
		feature = groupFeatures.selectAll("path")
			.data(collection.features)
			.enter().append("svg:path")
			.attr("d", path)
			.attr("class", "boundary")
			.attr("id", function(d){ return d.id; })
			.attr("title", function(d){ return d.properties.name; })
			.style("fill", function(d){ 
				var couleur = "#ccc";
				religionDominante.forEach(function(r){
					if(d.properties.name == r[0]){ 
						couleur = r[2]; 
					}		
				});	
				return couleur;	
			});	

	}); // fin du world-countries.json

}


</script>
</body>

