<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Blaspheme map 2013</title>
	<style>

	body {
		background: #fff;
	}
	
	svg {
		background: #fff;
	}

	.stroke {
		fill: none;
		stroke: #aaa;
		stroke-width: .2px;
	}

	.fill {
		fill: #fff;
	}

	.graticule {
		fill: none;
		stroke: #aaa;
		stroke-width: .2px;
	}

	.boundary {
		fill: none;
		stroke: #fff;
		stroke-width: .2px;
	}
	
	.NNN{ fill: #aaaaaa; }
	.ONN{ fill: #ff0000; }
	.NON{ fill: #dd0000; }
	.NNO{ fill: #bb0000; }
	.OON{ fill: #990000; }
	.NOO{ fill: #770000; }
	.ONO{ fill: #550000; }
	.OOO{ fill: #330000; }

	.legendeTexte {
		font-size: .6em;
		font-family: sans-serif;
		fill: #aaa;
	}
	
	.infosTexte {
		font-size: .6em;
		font-family: sans-serif;
		fill: #fff;
	}

	</style>
	<script src="d3.js"></script>
	<script src="http://d3js.org/d3.geo.projection.v0.min.js"></script>
	<script src="queue.v1.min.js"></script>
</head>	

<body>

<script>


var width = window.innerWidth, 
	height = window.innerHeight;

var projection = d3.geo
	//.azimuthalEqualArea()
	.mercator()
	//.kavrayskiy7()
	//.mollweide()
	//.peirceQuincuncial()
	//.conicEquidistant()
	//.orthographic()
	//.eisenlohr()
	.scale(100)
	.translate([width / 2, height / 2]);

var path = d3.geo.path().projection(projection);

var graticule = d3.geo.graticule();

var svg = d3.select("body").append("svg")
	.attr("width", width)
	.attr("height", height);


//création de la shpère de fond
svg.append("defs").append("path")
	.datum({type: "Sphere"})
	.attr("id", "sphere")
	.attr("d", path)
	.style("fill", "#fff");

svg.append("use")
	.attr("class", "stroke")
	.attr("xlink:href", "#sphere");

svg.append("use")
	.attr("class", "fill")
	.attr("xlink:href", "#sphere");

svg.append("path")
	.datum(graticule)
	.attr("class", "graticule")
	.attr("d", path);




var infosPays = [];
var carte = svg.append("svg:g");
var isZoomed = false;

var infosFond = svg.append("svg:rect");
infosFond.style("fill", "#ccc");
var infosTexte = [10];
for(var i = 0; i < 10; i++){
	infosTexte[i] = svg.append("svg:text");
	infosTexte[i].attr("class", "infosTexte");
}
	


	
queue()
	.defer(d3.csv, 	"blasphemeInfos.csv", 		function(d, i){ traiterInfos(d, i); })
	.defer(d3.json,	"world-countries.json", 	function(d){ dessinerCarte(d); })
	.awaitAll(ready());




function traiterInfos(d, i) {

	var categories = [ d.blasphème, d.apostasie, d.diffamation ];
	
	var nomClasse = "";
	categories.forEach(function(d, j){  	
		if(d == "oui"){ 
			nomClasse += "O";
		} else {
			nomClasse += "N";	
		}
	});	
	
	var mort = false;
	if(d.mort == "oui"){ mort = true; }
	
	infosPays.push([ d.iso, nomClasse, mort ]);
	
} 













function dessinerCarte(collection)
{
	
	// dessin de la carte
	carte.selectAll("path")
		.data(collection.features)
		.enter().append("svg:path")
		.attr("d", path)
		.attr("id", function(d){ return d.id; })
		.attr("title", function(d){ return d.properties.name; })
		.attr("class", function(d){
			
			var classe = ""; 
			infosPays.forEach(function(e, i){
				if(infosPays[i][0] == d.id)
				{
					classe = infosPays[i][1];
				}
			});
			return "boundary "+classe;
		})
		.on("mouseover", function(d){ over(d); })
		.on("mouseout", function(d){ out(d); })
		.on("click", function(d){ click(d); });
		
	


	
	// dessin du picto au niveau du centroid du pays
	collection.features.forEach(function(data) {
		var centroid = path.centroid(data);
		carte.append("svg:g")
			.attr("transform", "translate("+centroid[0]+", "+centroid[1]+") scale(1)")
			.append("svg:path")
				.attr("d", function(d){
					
					var forme = "";
					infosPays.forEach(function(e, i){
						if(infosPays[i][0] == data.id)
						{
							if(infosPays[i][2])
							{
								forme = "M0 0 L0 -5 M2 -3 L-2 -3";
							}
						}
					});
					return forme;
				})
				.style("stroke", "#fff");	
	});
	


	// legende
	var x = 10;
	var y = 10;
	var legende = svg.append("svg:g").attr("class", "legende");
	legende.append("svg:text").attr("class", "legendeTexte")
			.attr("x", x).attr("y", y)
			.text("Penalisation par la loi");
	y += 20;
			
	var categories = [ [ "NNN", "aucune"], [ "ONN", "blasphème" ], [ "NON", "apostasie" ], [ "NNO", "diffamation" ], [ "OON", "blasphème + apostasie" ], [ "NOO", "apostasie + diffamation" ], [ "ONO", "blasphème + diffamation"], [ "OOO", "la totale"] ];
	
	categories.forEach(function(d){
		legende.append("svg:rect")
			.attr("width", "10").attr("height", "10")
			.attr("x", x).attr("y", y)
			.attr("class", d[0]);
		legende.append("svg:text").attr("class", "legendeTexte")
			.attr("x", x+20).attr("y", y+10)
			.text(d[1]);
			
		y += 30;
	});
	
	y += 5;
	legende.append("svg:path")
		.attr("transform", "translate("+(x+5)+", "+(y+3)+") scale(2)")
		.attr("d", "M0 0 L0 -5 M2 -3 L-2 -3")
		.style("stroke", "#000");
	
	legende.append("svg:text").attr("class", "legendeTexte")
		.attr("x", x+20).attr("y", y)
		.text("puni de mort");	
		
}









// INTERACTION

function over(d)
{
	var cible = this.svg.select("#"+d.id);
	cible.transition()
		.duration(200)
		.attr("transform", "translate(0, -2)");
}


function out(d)
{
	var cible = this.svg.select("#"+d.id);
	cible.transition()
		.duration(200)
		.attr("transform", "translate(0, 0)");		
}




function click(d)
{ 

	// zoom
	var centroid = path.centroid(d);
	var scale = 0;
	var targetX, targetY;
	var pays = svg.selectAll(".boundary");
	
	if(!isZoomed)
	{
		pays.style("fill", "#aaa");
		var cible = svg.select("#"+d.id);
		cible.style("fill", "#f00");
		
		
		targetX = -centroid[0];
		targetY = -centroid[1];
		scale = 2;
	} else {
		
		colorerPays(pays);
		
		targetX = -(width / 2);
		targetY = -(height / 2);
		scale = 1;
	}
	
	
	carte.transition()
      		.duration(750)
      		.attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + scale + ")translate(" + targetX + "," + targetY + ")");
    
    
    
    // afficher info
    var fondLargeur, fondHauteur;
    var x = 300;
    var y = 2;
    
    if(!isZoomed)
	{
		infosTexte[0].text(d.properties.name);
		recupererInfos(d);
		fondLargeur = 200;
		fondHauteur = 260;
		
	} else {
		fondLargeur = 0;
		fondHauteur = 0;
		resetInfos();
	}
    
    infosFond.transition()
    	.duration(750)
    	.attr("x", x).attr("y", y)
    	.attr("width", fondLargeur).attr("height", fondHauteur);
	
	
	for(var i = 0; i < 10; i++){		
		infosTexte[i].transition()
	    	.duration(750)
	    	.attr("x", x+20).attr("y", y+20);
	    y += 20;
	}    
    
    
    isZoomed = !isZoomed;

}



function colorerPays(pays)
{
	pays.forEach(function(d){
		alert(d.id);
	});	
}



function resetInfos()
{
	for(var i = 0; i < 10; i++){		
		infosTexte[i].text("");
	}
}



function recupererInfos(data)
{
	var texte = "\n";
	var cow = "";
	d3.csv("COWstate.csv", function(d){	
 		d.forEach(function(e){
 			if(e.name == data.properties.name)
 			{
 				cow = e.cow;
 			}
 		});   	
    });
    
    d3.csv("WRPstate2010.csv", function(d){
    	d.forEach(function(e){
 			if(cow == e.name)
 			{
				infosTexte[1].text("Catholic: "+e.chrstcatpct+"%");
				infosTexte[2].text("Protestant: "+e.chrstprotpct+"%");
				infosTexte[3].text("Orthodox: "+e.chrstorthpct+"%");
				infosTexte[4].text("Anglican: "+e.chrstangpct+"%");
				infosTexte[5].text("Sunni: "+e.islmsunpct+"%");
				infosTexte[6].text("Shi'a: "+e.islmshipct+"%");
				infosTexte[7].text("Judaism: "+e.judgenpct+"%");
				infosTexte[8].text("Buddhism: "+e.budgenpct+"%");
				infosTexte[9].text("Taoism: "+e.taogenpct+"%");
 			}
 		});
    });
    
    
    
}



function ready()
{
	
}


</script>
</body>
</html>



