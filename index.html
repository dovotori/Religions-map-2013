<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Blaspheme map 2013</title>
	<style>

	body {
		text-align: center;
		background: #555;
	}
	
	svg {
		background: #555;
	}

	.graticule {
		fill: none;
		stroke: #aaa;
		stroke-width: .2px;
	}
	
	#sphere{
		fill: #555;	
	}

	.boundary {
		fill: none;
		stroke: #fff;
		stroke-width: .2px;
	}
	
	.noPenalty				{ fill: #bbb; }
	.blaspheme				{ fill: hsl(180, 50%, 50%); }
	.apostasie				{ fill: hsl(190, 50%, 50%); }
	.diffamation			{ fill: hsl(200, 50%, 50%); }
	.blasphemeApostasie		{ fill: hsl(303, 50%, 50%); }
	.apostasieDiffamation	{ fill: hsl(326, 50%, 50%); }
	.blasphemeDiffamation	{ fill: hsl(349, 50%, 50%); }	
	.allPenalties			{ fill: #000; }

	.legendeTexte {
		font-size: .8em;
		font-family: sans-serif;
		fill: #aaa;
	}
	
	.infosTitre {
		font-size: .8em;
		font-family: sans-serif;
		fill: #bbb;
	}
	
	.infosTitreCat {
		fill: #555;	
	}
	
	.infosTexte {
		font-size: .6em;
		font-family: sans-serif;
		fill: #555;
	}
	
	.capitaleTexte {
		font-size: .5em;
		font-family: sans-serif;
		fill: #555;
	}

	.capitalePoint {
		fill: #555;	
	}

	</style>
	<script src="d3.js"></script>
	<script src="http://d3js.org/d3.geo.projection.v0.min.js"></script>
	<script src="queue.v1.min.js"></script>
</head>	

<body>

<script>






var width, height;

var projection = d3.geo
	//.azimuthalEqualArea()
	.mercator()
	//.kavrayskiy7()
	//.mollweide()
	//.peirceQuincuncial()
	//.conicEquidistant()
	//.orthographic()
	//.eisenlohr()
	

var path = d3.geo.path().projection(projection);

var graticule = d3.geo.graticule();

var svg = d3.select("body").append("svg");

svg.append("defs").append("path")
	.datum({type: "Sphere"})
	.attr("id", "sphere")
	.attr("d", path);

svg.append("use")
	.attr("class", "stroke")
	.attr("xlink:href", "#sphere");

svg.append("use")
	.attr("class", "fill")
	.attr("xlink:href", "#sphere");

var dessinGraticule = svg.append("path")
	.datum(graticule)
	.attr("class", "graticule")
	.attr("d", path);






var infosPays = [];
var carte = svg.append("svg:g").attr("id", "carte");
var capitalePoint = carte.append("rect").attr("class", "capitalePoint");
var capitaleTexte = carte.append("rect").attr("class", "capitaleTexte");
var pictoPath;
var categories;


// INTERACTION
var paysClique, oldPaysCliqueId;
var isZoomed = false;
var infos = svg.append("svg:g").attr("id", "infos");
var infosFond = infos.append("svg:rect").attr("id", "infosFond").style("fill", "#eee");
var infosTitre = [2];
infosTitre[0] = infos.append("svg:text").attr("class", "infosTitre");
infosTitre[1] = infos.append("svg:text").attr("class", "infosTitre infosTitreCat");

var nbCat = 9;
var infosTexte = [nbCat];
for(var i = 0; i < nbCat; i++){
	infosTexte[i] = infos.append("svg:text").attr("class", "infosTexte");
}
var infosValeurs = [3]; infosValeurs[0] = []; infosValeurs[1] = []; infosValeurs[2] = [];
var cow = ""; var isInformed;
var pie = d3.layout.pie().sort(null).value(function(d) { return d; });    
var arc = d3.svg.arc().outerRadius(20).innerRadius(60);
var donut = infos.selectAll(".arc");
var legendeReligionsCarres = [nbCat];
var legendeReligionsTextes = [nbCat];
for(var i = 0; i < nbCat; i++)
{
	legendeReligionsCarres[i] = infos.append("svg:rect");
	legendeReligionsTextes[i] = infos.append("svg:text");
}


		







resize();
	
queue()
	.defer(d3.csv, 	"blasphemeInfos.csv", 		function(d, i){ traiterInfosBlaspheme(d, i); })
	.defer(d3.csv, 	"pictoMort.csv", 			function(d){ traiterPictos(d)})
	.defer(d3.json,	"world-countries.json", 	function(d){ dessinerCarte(d); })
	.awaitAll(ready());




function traiterInfosBlaspheme(d, i) {

	var categories = [ d.blasphème, d.apostasie, d.diffamation ];
	
	var nomClasse = "";
	categories.forEach(function(d, j){  	
		if(d == "oui"){ 
			nomClasse += "O";
		} else {
			nomClasse += "N";	
		}
	});	
	
	switch(nomClasse)
	{
		case "NNN": nomClasse = "noPenalty"; break;	
		case "ONN": nomClasse = "blaspheme"; break;	
		case "NON": nomClasse = "apostasie"; break;	
		case "NNO": nomClasse = "diffamation"; break;	
		case "OON": nomClasse = "blasphemeApostasie"; break;	
		case "NOO": nomClasse = "apostasieDiffamation"; break;	
		case "ONO": nomClasse = "blasphemeDiffamation"; break;	
		case "OOO": nomClasse = "allPenalties"; break;	
	}
	
	var mort = false;
	if(d.mort == "oui"){ mort = true; }

	infosPays.push([ d.iso, nomClasse, mort ]);
	
} 




function traiterPictos(data)
{
	pictoPath = data.path;
}





function dessinerCarte(collection)
{
	
	// CARTE
	carte.selectAll("path")
		.data(collection.features)
		.enter().append("svg:path")
		.attr("d", path)
		.attr("id", function(d){ return d.id; })
		.attr("title", function(d){ return d.properties.name; })
		.attr("name", "pays")
		.attr("class", function(d){
			
			var classe = ""; 
			infosPays.forEach(function(e, i){
				if(infosPays[i][0] == d.id)
				{
					classe = infosPays[i][1];
				}
			});
			return "boundary "+classe;
		})
		.on("mouseover", function(d){ hoverPays(d); })
		.on("mouseout", function(d){ outPays(d); })
		.on("click", function(d){ clickPays(d); });
		
	


	
	// PICTOS
	collection.features.forEach(function(data) {
		var centroid = path.centroid(data);
		carte.append("svg:g")
			.attr("transform", "translate("+centroid[0]+", "+centroid[1]+") scale(0.4)")
			.append("svg:path")
				.attr("class", "pictosMort")
				.attr("d", function(d){
					
					var forme = "";
					infosPays.forEach(function(e, i){
						if(infosPays[i][0] == data.id)
						{
							if(infosPays[i][2])
							{
								forme = pictoPath;
							}
						}
					});
					return forme;
				})
				.style("fill", "#fff");	
	});
	


	// LEGENDE
	var x = 10;
	var y = 14;
	var legende = svg.append("svg:g").attr("class", "legende");
	legende.append("svg:text").attr("class", "infosTitre")
			.attr("x", x).attr("y", y)
			.text("Penalisation par la loi");
	y += 20;
			
	categories = [ [ "noPenalty", 				"aucune"], 
					[ "blaspheme", 				"blasphème" ], 
					[ "apostasie", 				"apostasie" ], 
					[ "diffamation", 			"diffamation" ], 
					[ "blasphemeApostasie", 	"blasphème + apostasie" ], 
					[ "apostasieDiffamation", 	"apostasie + diffamation" ], 
					[ "blasphemeDiffamation", 	"blasphème + diffamation"], 
					[ "allPenalties", 			"la totale"] ];
	
	
	
	categories.forEach(function(d){
		legende.append("svg:rect")
			.attr("width", "10").attr("height", "10")
			.attr("x", x).attr("y", y)
			.attr("class", d[0]);
		legende.append("svg:text").attr("class", "legendeTexte")
			.attr("x", x+20).attr("y", y+10)
			.text(d[1]);
			
		y += 30;
	});
	
	y += 5;
	
	// picto mort en derniere ligne
	legende.append("svg:path")
		.attr("transform", "translate("+(x+5)+", "+(y-3)+") scale(1)")
		.attr("d", pictoPath)
		.style("fill", "#000");
	
	legende.append("svg:text").attr("class", "legendeTexte")
		.attr("x", x+20).attr("y", y)
		.text("puni de mort");			
}




function ready()
{
	var hash = window.location.hash;	
	if(hash != "#" && hash != "" && hash != "general")
	{
		d3.json("world-countries.json", function(collection){ 
			
			collection.features.forEach(function(d){
				if(hash == "#"+d.id){ paysClique = d; zoomPays(); }	
			});
		});
	}
}


















/////////////////////////////////////
// INTERACTION /////////////////////
///////////////////////////////////


function hoverPays(d)
{
	/*if(!isZoomed)
	{
		var cible = this.svg.select("#"+d.id);
		cible.transition()
			.duration(100)
			.style("fill", "#c00");
	}*/
}


function outPays(d)
{
	/*if(!isZoomed)
	{
		
		var cible = this.svg.select("#"+d.id);
		cible.transition()
			.duration(100)
			.style("fill", null);		
	}*/
}





function clickPays(d)
{ 		
	paysClique = d;	
}







svg.on("click", clicSvg);

function clicSvg()
{
	
	resetInfos();
	
	if(d3.event.target.id.length == 3 && (oldPaysCliqueId != paysClique.id || !isZoomed))
	{
		
		zoomPays();
		    	
	} else {
	
		dezoomPays();
	    	
	}
	
}




function dezoomPays()
{
	
	window.location.hash = "general";
		
	// recolorer pays
	/*infosPays.forEach(function(d){
		var cible = carte.select("#"+d[0]);
		if (typeof(cible) != 'undefined')
		{ 
			cible.style("fill", null);
		}
	});*/	
		
	carte.transition()
     		.duration(750)
     		.attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + 1 + ")translate(" + -(width / 2) + "," + -(height / 2) + ")");
    
    infosFond.transition()
    	.duration(750)
    	.attr("width", 0).attr("height", 0);
    	
    isZoomed = false;
	
}



function zoomPays()
{

	// ZOOM PAYS	
	clicPays = true;	
	isInformed = false;
	var centroid = path.centroid(paysClique);
	window.location.hash = paysClique.id;

	// couleurs pour le pays cliqué
	/*d3.selectAll(".boundary").transition().duration(750).style("fill", "#aaa");
	var cible = svg.select("#"+paysClique.id);
	cible.transition().duration(750).style("fill", "#f00");*/
	
	// fond des infos
	infosFond.x = width/2+200;
	infosFond.y = height/2-135;
	infosFond.attr("x", infosFond.x).attr("y", infosFond.y);
	infosFond.attr("width", 0).attr("height", 0);

	carte.transition()
     		.duration(750)
     		.attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + 2 + ")translate(" + -centroid[0] + "," + -centroid[1] + ")");
    
    infosFond.transition()
    	.duration(750)
    	.attr("width", 400).attr("height", 270)
    	.each("end", afficherInfos );
    	
    oldPaysCliqueId = paysClique.id;
    
    isZoomed = true;
	
}



function resetInfos()
{
	
	infosTitre[0].text("");
	infosTitre[1].text("");
	for(var i = 0; i < nbCat; i++){	
		infosTexte[i].text("");
		infosValeurs[0][i] = 0;
		legendeReligionsCarres[i].remove();
		legendeReligionsTextes[i].remove(); 
	}
	donut.remove();
	capitaleTexte.remove();
	capitalePoint.remove();	
}




function afficherInfos()
{
	
	// titre
	infosTitre[0].text(paysClique.properties.name);
	
	// rappel de la penalisation
	var cible = document.getElementById(paysClique.id);
	var classe = cible.className.baseVal.split(" ", 2)[1];
	
	categories.forEach(function(d, i){
		if(classe == d[0]){ infosTitre[1].text("Pénalisations : "+d[1]); }
	});

	queue()
		.defer(d3.csv,  "couleursReligions.csv",	function(d, i){ test(d, i); })
		.defer(d3.csv, 	"COWstate.csv", 			function(d){ traiterNoms(d); })
		.defer(d3.csv, 	"WRPstate2010.csv", 		function(d){ traiterReligions(d); })
		//.defer(d3.csv ,	"listeCapitalesPosition.csv", 	function(d){ dessinerCapitales(d); })
		.awaitAll(dessinerInfos);
	
}



function test(d, i){
	
	infosValeurs[1][i] = d.name;
	infosValeurs[2][i] = d.color;
}



function traiterNoms(d)
{
	if(d.name == paysClique.properties.name)
	{
		cow = d.cow;
		isInformed = true;
	}
}



function traiterReligions(d)
{	
	
	if(isInformed && cow == d.name)
	{
		
		infosValeurs[0][0] = d.chrstcatpct;
		infosValeurs[0][1] = d.chrstprotpct;
		infosValeurs[0][2] = d.chrstorthpct;
		infosValeurs[0][3] = d.chrstangpct;
		infosValeurs[0][4] = d.islmsunpct;
		infosValeurs[0][5] = d.islmshipct;
		infosValeurs[0][6] = d.judgenpct;
		infosValeurs[0][7] = d.budgenpct;
		infosValeurs[0][8] = d.taogenpct;
		
	}
}




function dessinerInfos()
{
	
	infosTitre[0].attr("x", infosFond.x+20).attr("y", infosFond.y+30); 
	infosTitre[1].attr("x", infosFond.x+20).attr("y", infosFond.y+250); 
	
	if(isInformed && isZoomed)
	{		  
		
		donut = infos.selectAll(".arc")
		    .data(pie(infosValeurs[0]))
			.enter().append("g")
		    .attr("class", "arc");
		      
		donut.append("path")
		    .attr("d", arc)
		    .style("fill", function(d, i){ return "hsl("+infosValeurs[2][i]+", 80%, 50%)"; })
		    .attr("title", function(d, i){ return infosValeurs[1][i]+": "+d.data*100+"%"; })
		    .attr("transform", "translate("+(infosFond.x+100)+", "+(infosFond.y+120)+")")
		    .each(function(d, i){ 
		    	legendeReligionsCarres[i] = infos.append("svg:rect")
		    		.attr("width", 10).attr("height", 10)
		    		.attr("x", infosFond.x+200).attr("y", infosFond.y+52)
		    		.style("fill", "hsl("+infosValeurs[2][i]+", 80%, 50%)");
		    	legendeReligionsTextes[i] = infos.append("svg:text").attr("class", "infosTexte")
		    		.attr("x", infosFond.x+220).attr("y", infosFond.y+60)
		    		.text(infosValeurs[1][i]);
		    	infosFond.y += 20;
		    });	
		    
	} else if(!isInformed){
		
		for(var i = 0; i < nbCat; i++)
		{
			legendeReligionsCarres[i] = infos.append("svg:rect");
			legendeReligionsTextes[i] = infos.append("svg:text");
		}
		
		legendeReligionsTextes[0].attr("class", "infosTexte")
			.attr("x", infosFond.x+20).attr("y", infosFond.y+60)
		    .text("unknow");
	
	}
}



function dessinerCapitales(data)
{ 
	
	
	if(data.country == paysClique.properties.name)
	{
		
		// conversion des latitudes et longitudes
		var lat = parseFloat(data.lat.substring(0, data.lat.length-1));
		var sens = data.lat.substring(data.lat.length-1, data.lat.length);
		if(sens == "S"){ lat *= -1; }
		var long = parseFloat(data.long.substring(0, data.long.length-1));
		sens = data.long.substring(data.long.length-1, data.long.length);
		if(sens == "W"){ long *= -1; }
		
		var coordonnees = [ long, lat ];
		var traductionCoor = projection(coordonnees);
		var x = traductionCoor[0];
		var y = traductionCoor[1];
	
		capitalePoint = carte.append("rect").attr("class", "capitalePoint");
		capitaleTexte = carte.append("svg:text").attr("class", "capitaleTexte");
	
		// dessiner un point
		capitalePoint.attr("width", 3).attr("height", 3)
			.attr("x", x).attr("y", y);
			
	
		// dessiner le nom de la capitale
		capitaleTexte.attr("x", x+6).attr("y", y+4)
			.text(data.capital);

	}
	
}






////////////////////////////
//// RESIZE ///////////////
//////////////////////////

d3.select(window).on('resize', resize);

function resize() {

    width = window.innerWidth; 
	height = window.innerHeight;

    // update projection
    projection
        .translate([width / 2, height / 2])
        .scale(width / 10);

	
	svg
		.attr("width", width)
		.attr("height", height);

    carte
        .style('width', width)
        .style('height', height);
        
	
    dessinGraticule.attr('d', path);
    carte.selectAll("path").attr('d', path);
	
}






</script>
</body>
</html>





