<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Blaspheme map 2013</title>
	<style>

	body {
		background: #fff;
	}
	
	svg {
		background: #fff;
		width: 100%;
	}

	#carte{
		background-size: contain;	
	}

	.stroke {
		fill: none;
		stroke: #aaa;
		stroke-width: .2px;
	}

	.graticule {
		fill: none;
		stroke: #aaa;
		stroke-width: .2px;
	}

	.boundary {
		fill: none;
		stroke: #fff;
		stroke-width: .2px;
	}
	
	.NNN{ fill: #bbb; }
	
	.ONN{ fill: hsl(43, 50%, 50%); }
	.NON{ fill: hsl(149, 50%, 50%); }
	.NNO{ fill: hsl(350, 50%, 50%); }
	
	.OON{ fill: hsl(43, 60%, 40%); }
	.NOO{ fill: hsl(149, 60%, 40%); }
	.ONO{ fill: hsl(350, 60%, 40%); }
	
	.OOO{ fill: #000; }

	.legendeTexte {
		font-size: .6em;
		font-family: sans-serif;
		fill: #aaa;
	}
	
	.infosTitre {
		font-size: .8em;
		font-family: sans-serif;
		fill: #f00;
	}
	
	.infosTitreCat {
		fill: #555;	
	}
	
	.infosTexte {
		font-size: .6em;
		font-family: sans-serif;
		fill: #555;
	}
	
	.capitaleTexte {
		font-size: .5em;
		font-family: sans-serif;
		fill: #555;
	}

	.capitalePoint {
		fill: #555;	
	}

	</style>
	<script src="d3.js"></script>
	<script src="http://d3js.org/d3.geo.projection.v0.min.js"></script>
	<script src="queue.v1.min.js"></script>
</head>	

<body>

<script>






var width = window.innerWidth, 
	height = window.innerHeight;

var projection = d3.geo
	//.azimuthalEqualArea()
	.mercator()
	//.kavrayskiy7()
	//.mollweide()
	//.peirceQuincuncial()
	//.conicEquidistant()
	//.orthographic()
	//.eisenlohr()
	.scale(100)
	.translate([width / 2, height / 2]);

var path = d3.geo.path().projection(projection);

var graticule = d3.geo.graticule();

var svg = d3.select("body").append("svg")
	.attr("width", width)
	.attr("height", height);


//création de la shpère de fond
svg.append("defs").append("path")
	.datum({type: "Sphere"})
	.attr("id", "sphere")
	.attr("d", path)
	.style("fill", "#fff");

svg.append("use")
	.attr("class", "stroke")
	.attr("xlink:href", "#sphere");

svg.append("use")
	.attr("class", "fill")
	.attr("xlink:href", "#sphere");

svg.append("path")
	.datum(graticule)
	.attr("class", "graticule")
	.attr("d", path);






var infosPays = [];
var carte = svg.append("svg:g").attr("id", "carte");
var capitalePoint;
var capitaleTexte;
var pictoPath;
var isZoomed = false;
var categories;


// INTERACTION
var infos = svg.append("svg:g").attr("id", "infos");
var infosFond = infos.append("svg:rect").attr("id", "infosFond").style("fill", "#eee");
var infosTitre = [2];
infosTitre[0] = infos.append("svg:text").attr("class", "infosTitre");
infosTitre[1] = infos.append("svg:text").attr("class", "infosTitre infosTitreCat");
var nbCat = 9;
var infosTexte = [nbCat];
for(var i = 0; i < nbCat; i++){
	infosTexte[i] = infos.append("svg:text").attr("class", "infosTexte");
}
var infosValeurs = [3]; infosValeurs[0] = []; infosValeurs[1] = []; infosValeurs[2] = [];
var paysClique;
var cow = ""; var isInformed;
var pie = d3.layout.pie().sort(null).value(function(d) { return d; });    
var arc = d3.svg.arc().outerRadius(20).innerRadius(60);
var donut = infos.selectAll(".arc");
var legendeReligionsCarres = [nbCat];
var legendeReligionsTextes = [nbCat];


		








	
queue()
	.defer(d3.csv, 	"blasphemeInfos.csv", 		function(d, i){ traiterInfosBlaspheme(d, i); })
	.defer(d3.csv, 	"pictoMort.csv", 			function(d){ traiterPictos(d)})
	.defer(d3.json,	"world-countries.json", 	function(d){ dessinerCarte(d); })
	.awaitAll(ready());




function traiterInfosBlaspheme(d, i) {

	var categories = [ d.blasphème, d.apostasie, d.diffamation ];
	
	var nomClasse = "";
	categories.forEach(function(d, j){  	
		if(d == "oui"){ 
			nomClasse += "O";
		} else {
			nomClasse += "N";	
		}
	});	
	
	var mort = false;
	if(d.mort == "oui"){ mort = true; }

	infosPays.push([ d.iso, nomClasse, mort ]);
	
} 




function traiterPictos(data)
{
	pictoPath = data.path;
}





function dessinerCarte(collection)
{
	
	// CARTE
	carte.selectAll("path")
		.data(collection.features)
		.enter().append("svg:path")
		.attr("d", path)
		.attr("id", function(d){ return d.id; })
		.attr("title", function(d){ return d.properties.name; })
		.attr("name", "pays")
		.attr("class", function(d){
			
			var classe = ""; 
			infosPays.forEach(function(e, i){
				if(infosPays[i][0] == d.id)
				{
					classe = infosPays[i][1];
				}
			});
			return "boundary "+classe;
		})
		.on("mouseover", function(d){ over(d); })
		.on("mouseout", function(d){ out(d); })
		.on("click", function(d){ click(d); });
		
	


	
	// PICTOS
	collection.features.forEach(function(data) {
		var centroid = path.centroid(data);
		carte.append("svg:g")
			.attr("transform", "translate("+centroid[0]+", "+centroid[1]+") scale(0.4)")
			.append("svg:path")
				.attr("d", function(d){
					
					var forme = "";
					infosPays.forEach(function(e, i){
						if(infosPays[i][0] == data.id)
						{
							if(infosPays[i][2])
							{
								forme = pictoPath;
							}
						}
					});
					return forme;
				})
				.style("fill", "#fff");	
	});
	


	// LEGENDE
	var x = 10;
	var y = 14;
	var legende = svg.append("svg:g").attr("class", "legende");
	legende.append("svg:text").attr("class", "infosTitre")
			.attr("x", x).attr("y", y)
			.text("Penalisation par la loi");
	y += 20;
			
	categories = [ [ "NNN", "aucune"], 
					[ "ONN", "blasphème" ], 
					[ "NON", "apostasie" ], 
					[ "NNO", "diffamation" ], 
					[ "OON", "blasphème + apostasie" ], 
					[ "NOO", "apostasie + diffamation" ], 
					[ "ONO", "blasphème + diffamation"], 
					[ "OOO", "la totale"] ];
	
	categories.forEach(function(d){
		legende.append("svg:rect")
			.attr("width", "10").attr("height", "10")
			.attr("x", x).attr("y", y)
			.attr("class", d[0]);
		legende.append("svg:text").attr("class", "legendeTexte")
			.attr("x", x+20).attr("y", y+10)
			.text(d[1]);
			
		y += 30;
	});
	
	y += 5;
	
	// picto mort en derniere ligne
	legende.append("svg:path")
		.attr("transform", "translate("+(x+5)+", "+(y-3)+") scale(1)")
		.attr("d", pictoPath)
		.style("fill", "#000");
	
	legende.append("svg:text").attr("class", "legendeTexte")
		.attr("x", x+20).attr("y", y)
		.text("puni de mort");			
}




function ready()
{
	var hash = window.location.hash;	
	if(hash != "#" && hash != "" && hash != "general")
	{
		d3.json("world-countries.json", function(collection){ 
			
			collection.features.forEach(function(d){
				if(hash == "#"+d.id){ click(d); isZoomed = !isZoomed; }	
			});
		});
	}
}


















/////////////////////////////////////
// INTERACTION /////////////////////
///////////////////////////////////


function over(d)
{
	if(!isZoomed)
	{
		var cible = this.svg.select("#"+d.id);
		cible.transition()
			.duration(100)
			.style("fill", "#c00");
	}
}


function out(d)
{
	if(!isZoomed)
	{
		
		var cible = this.svg.select("#"+d.id);
		cible.transition()
			.duration(100)
			.style("fill", null);		
	}
}





function click(d)
{ 
	
		
	// ZOOM PAYS
	if(!isZoomed)
	{	
		
		paysClique = d;
		isInformed = false;
		var centroid = path.centroid(paysClique);
		window.location.hash = paysClique.id;
	
		// couleurs pour le pays cliqué
		d3.selectAll(".boundary").transition().duration(750).style("fill", "#aaa");
		var cible = svg.select("#"+paysClique.id);
		cible.transition().duration(750).style("fill", "#f00");
		
		// fond des infos
		infosFond.x = width/2+200;
		infosFond.y = height/2-135;
		infosFond.attr("x", infosFond.x).attr("y", infosFond.y);
		infosFond.attr("width", 0).attr("height", 0);
	
		carte.transition()
      		.duration(750)
      		.attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + 2 + ")translate(" + -centroid[0] + "," + -centroid[1] + ")");
	    
	    infosFond.transition()
	    	.duration(750)
	    	.attr("width", 400).attr("height", 270)
	    	.each("end", afficherInfos );
	    	
	}
    
}




svg.on("click", clicSvg);

function clicSvg()
{
	
	// DEZOOM PAYS
	if(isZoomed)
	{
		
		window.location.hash = "general";
			
		// recolorer pays
		infosPays.forEach(function(d){
			var cible = carte.select("#"+d[0]);
			if (typeof(cible) != 'undefined')
			{ 
				cible.style("fill", null);
			}
		});
		
		// reset les infos
		infosTitre[0].text("");
		infosTitre[1].text("");
		for(var i = 0; i < nbCat; i++){	
			infosTexte[i].text("");
			infosValeurs[0][i] = 0;
			legendeReligionsCarres[i].remove();
			legendeReligionsTextes[i].remove(); 
		}
		donut.remove();
		capitaleTexte.remove();
		capitalePoint.remove();
			
		carte.transition()
      		.duration(750)
      		.attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + 1 + ")translate(" + -(width / 2) + "," + -(height / 2) + ")");
	    
	    infosFond.transition()
	    	.duration(750)
	    	.attr("width", 0).attr("height", 0);

	}
	
	isZoomed = !isZoomed;
	
}




function afficherInfos()
{
	
		// titre
		infosTitre[0].text(paysClique.properties.name);
		
		// rappel de la penalisation
		var cible = document.getElementById(paysClique.id);
		var classe = cible.className.baseVal.split(" ", 2)[1];
		
		categories.forEach(function(d, i){
			if(classe == d[0]){ infosTitre[1].text("Pénalisations : "+d[1]); }
		});
	
		queue()
			.defer(d3.csv,  "couleursReligions.csv",	function(d, i){ test(d, i); })
			.defer(d3.csv, 	"COWstate.csv", 			function(d){ traiterNoms(d); })
			.defer(d3.csv, 	"WRPstate2010.csv", 		function(d){ traiterReligions(d); })
			.defer(d3.csv ,	"listeCapitalesPosition.csv", 	function(d){ dessinerCapitales(d); })
			.awaitAll(dessinerInfos);
	
}



function test(d, i){
	
	infosValeurs[1][i] = d.name;
	infosValeurs[2][i] = d.color;
}



function traiterNoms(d)
{
	if(d.name == paysClique.properties.name)
	{
		cow = d.cow;
		isInformed = true;
	}
}



function traiterReligions(d)
{	
	
	if(isInformed && cow == d.name)
	{
		
		infosValeurs[0][0] = d.chrstcatpct;
		infosValeurs[0][1] = d.chrstprotpct;
		infosValeurs[0][2] = d.chrstorthpct;
		infosValeurs[0][3] = d.chrstangpct;
		infosValeurs[0][4] = d.islmsunpct;
		infosValeurs[0][5] = d.islmshipct;
		infosValeurs[0][6] = d.judgenpct;
		infosValeurs[0][7] = d.budgenpct;
		infosValeurs[0][8] = d.taogenpct;
		
	}
}




function dessinerInfos()
{
	
	infosTitre[0].attr("x", infosFond.x+20).attr("y", infosFond.y+30); 
	infosTitre[1].attr("x", infosFond.x+20).attr("y", infosFond.y+250); 
	
	if(isInformed && isZoomed)
	{		  
		
		donut = infos.selectAll(".arc")
		    .data(pie(infosValeurs[0]))
			.enter().append("g")
		    .attr("class", "arc");
		      
		donut.append("path")
		    .attr("d", arc)
		    .style("fill", function(d, i){ return "hsl("+infosValeurs[2][i]+", 80%, 50%)"; })
		    .attr("title", function(d, i){ return infosValeurs[1][i]+": "+d.data*100+"%"; })
		    .attr("transform", "translate("+(infosFond.x+100)+", "+(infosFond.y+120)+")")
		    .each(function(d, i){ 
		    	legendeReligionsCarres[i] = infos.append("svg:rect")
		    		.attr("width", 10).attr("height", 10)
		    		.attr("x", infosFond.x+200).attr("y", infosFond.y+52)
		    		.style("fill", "hsl("+infosValeurs[2][i]+", 80%, 50%)");
		    	legendeReligionsTextes[i] = infos.append("svg:text").attr("class", "infosTexte")
		    		.attr("x", infosFond.x+220).attr("y", infosFond.y+60)
		    		.text(infosValeurs[1][i]);
		    	infosFond.y += 20;
		    });	
		    
	} else if(!isInformed){
		
		for(var i = 0; i < nbCat; i++)
		{
			legendeReligionsCarres[i] = infos.append("svg:rect");
			legendeReligionsTextes[i] = infos.append("svg:text");
		}
		
		legendeReligionsTextes[0].attr("class", "infosTexte")
			.attr("x", infosFond.x+20).attr("y", infosFond.y+60)
		    .text("unknow");
	
	}
}



function dessinerCapitales(data)
{ 
	
	
	if(data.country == paysClique.properties.name)
	{
		
		// conversion des latitudes et longitudes
		var lat = parseFloat(data.lat.substring(0, data.lat.length-1));
		var sens = data.lat.substring(data.lat.length-1, data.lat.length);
		if(sens == "S"){ lat *= -1; }
		var long = parseFloat(data.long.substring(0, data.long.length-1));
		sens = data.long.substring(data.long.length-1, data.long.length);
		if(sens == "W"){ long *= -1; }
		
		var coordonnees = [ long, lat ];
		var traductionCoor = projection(coordonnees);
		var x = traductionCoor[0];
		var y = traductionCoor[1];
	
		capitalePoint = carte.append("rect").attr("class", "capitalePoint");
		capitaleTexte = carte.append("svg:text").attr("class", "capitaleTexte");
	
		// dessiner un point
		capitalePoint.attr("width", 3).attr("height", 3)
			.attr("x", x).attr("y", y);
			
	
		// dessiner le nom de la capitale
		capitaleTexte.attr("x", x+6).attr("y", y+4)
			.text(data.capital);

	}
	
}



</script>
</body>
</html>





